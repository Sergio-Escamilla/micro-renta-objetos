{"ast":null,"code":"import { Validators } from '@angular/forms';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nimport * as i2 from \"@angular/forms\";\nimport * as i3 from \"src/app/core/services/articulo.service\";\nimport * as i4 from \"src/app/core/services/auth.service\";\nimport * as i5 from \"src/app/core/services/renta.service\";\nimport * as i6 from \"@angular/common\";\nfunction RentarArticuloComponent_div_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 8)(1, \"div\", 9);\n    i0.ɵɵtext(2, \"1\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(3, \"div\", 10);\n    i0.ɵɵelementStart(4, \"div\", 9);\n    i0.ɵɵtext(5, \"2\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"div\", 11);\n    i0.ɵɵtext(7);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵclassProp(\"active\", ctx_r0.step === 1)(\"done\", ctx_r0.step > 1);\n    i0.ɵɵadvance(3);\n    i0.ɵɵclassProp(\"active\", ctx_r0.step === 2);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\"Paso \", ctx_r0.step, \" de 2\");\n  }\n}\nfunction RentarArticuloComponent_ng_container_9_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r2 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵelementStart(1, \"div\", 12);\n    i0.ɵɵtext(2, \" Acci\\u00F3n no disponible para administradores. \");\n    i0.ɵɵelementStart(3, \"div\", 13)(4, \"button\", 4);\n    i0.ɵɵlistener(\"click\", function RentarArticuloComponent_ng_container_9_Template_button_click_4_listener() {\n      i0.ɵɵrestoreView(_r2);\n      const ctx_r0 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r0.irAExplorar());\n    });\n    i0.ɵɵtext(5, \"Volver a Explorar\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementContainerEnd();\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 16);\n    i0.ɵɵtext(1, \"Cargando...\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_div_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 12);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", ctx_r0.errorMessage, \" \");\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_ng_container_3_div_4_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 22);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    let tmp_4_0;\n    const ctx_r0 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate2(\" $\", ctx_r0.modalidad === \"horas\" ? (tmp_4_0 = ctx_r0.articulo.precio_renta_hora) !== null && tmp_4_0 !== undefined ? tmp_4_0 : ctx_r0.articulo.precio_base : (tmp_4_0 = ctx_r0.articulo.precio_renta_dia) !== null && tmp_4_0 !== undefined ? tmp_4_0 : ctx_r0.articulo.precio_base, \" / \", ctx_r0.modalidad === \"horas\" ? \"hora\" : \"d\\u00EDa\", \" \");\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_ng_container_3_ng_template_5_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 22);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate2(\" $\", ctx_r0.articulo.precio_base, \" / \", ctx_r0.articulo.unidad_precio === \"por_hora\" ? \"hora\" : ctx_r0.articulo.unidad_precio === \"por_semana\" ? \"semana\" : \"d\\u00EDa\", \" \");\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_ng_container_3_div_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 12);\n    i0.ɵɵtext(1, \" No puedes rentar tu propio art\\u00EDculo. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_ng_container_3_form_8_div_18_span_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1, \"No disponible por d\\u00EDa.\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_ng_container_3_form_8_div_18_span_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1, \"No disponible por hora.\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_ng_container_3_form_8_div_18_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 33);\n    i0.ɵɵtemplate(1, RentarArticuloComponent_ng_container_10_ng_container_3_form_8_div_18_span_1_Template, 2, 0, \"span\", 7)(2, RentarArticuloComponent_ng_container_10_ng_container_3_form_8_div_18_span_2_Template, 2, 0, \"span\", 7);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext(4);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", !ctx_r0.permiteDias);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", !ctx_r0.permiteHoras);\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_ng_container_3_form_8_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r3 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"form\", 23);\n    i0.ɵɵlistener(\"ngSubmit\", function RentarArticuloComponent_ng_container_10_ng_container_3_form_8_Template_form_ngSubmit_0_listener() {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r0 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r0.continuar());\n    });\n    i0.ɵɵelementStart(1, \"div\", 24)(2, \"div\", 25)(3, \"label\");\n    i0.ɵɵtext(4, \"Inicio\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(5, \"input\", 26);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"div\", 25)(7, \"label\");\n    i0.ɵɵtext(8, \"Fin\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(9, \"input\", 27);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(10, \"div\", 25)(11, \"label\");\n    i0.ɵɵtext(12, \"Modalidad\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(13, \"select\", 28);\n    i0.ɵɵlistener(\"change\", function RentarArticuloComponent_ng_container_10_ng_container_3_form_8_Template_select_change_13_listener($event) {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r0 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r0.onModalidadChange($event.target.value));\n    });\n    i0.ɵɵelementStart(14, \"option\", 29);\n    i0.ɵɵtext(15, \"D\\u00EDas\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(16, \"option\", 30);\n    i0.ɵɵtext(17, \"Horas\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵtemplate(18, RentarArticuloComponent_ng_container_10_ng_container_3_form_8_div_18_Template, 3, 2, \"div\", 31);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(19, \"button\", 32);\n    i0.ɵɵtext(20, \" Continuar \");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext(3);\n    i0.ɵɵproperty(\"formGroup\", ctx_r0.form);\n    i0.ɵɵadvance(5);\n    i0.ɵɵattribute(\"step\", ctx_r0.modalidad === \"horas\" ? 3600 : 60);\n    i0.ɵɵadvance(4);\n    i0.ɵɵattribute(\"step\", ctx_r0.modalidad === \"horas\" ? 3600 : 60);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"value\", ctx_r0.modalidad)(\"disabled\", ctx_r0.loading);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"disabled\", !ctx_r0.permiteDias);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"disabled\", !ctx_r0.permiteHoras);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", !ctx_r0.permiteDias || !ctx_r0.permiteHoras);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"disabled\", ctx_r0.loading || ctx_r0.esMio);\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_ng_container_3_div_9_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r4 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 34)(1, \"div\", 35);\n    i0.ɵɵtext(2, \"Confirmar\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"div\", 36)(4, \"div\")(5, \"strong\");\n    i0.ɵɵtext(6, \"Subtotal renta:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(7);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"div\")(9, \"strong\");\n    i0.ɵɵtext(10, \"Dep\\u00F3sito:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(11);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(12, \"div\", 37)(13, \"strong\");\n    i0.ɵɵtext(14, \"Total:\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtext(15);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(16, \"div\", 38)(17, \"button\", 39);\n    i0.ɵɵlistener(\"click\", function RentarArticuloComponent_ng_container_10_ng_container_3_div_9_Template_button_click_17_listener() {\n      i0.ɵɵrestoreView(_r4);\n      const ctx_r0 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r0.volverPaso1());\n    });\n    i0.ɵɵtext(18, \"Volver\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(19, \"button\", 40);\n    i0.ɵɵlistener(\"click\", function RentarArticuloComponent_ng_container_10_ng_container_3_div_9_Template_button_click_19_listener() {\n      i0.ɵɵrestoreView(_r4);\n      const ctx_r0 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r0.confirmarRenta());\n    });\n    i0.ɵɵtext(20);\n    i0.ɵɵelementEnd()()();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext(3);\n    i0.ɵɵadvance(7);\n    i0.ɵɵtextInterpolate1(\" $\", ctx_r0.subtotalEstimado, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" $\", ctx_r0.depositoEstimado, \"\");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" $\", ctx_r0.totalEstimado, \"\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"disabled\", ctx_r0.loading);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"disabled\", ctx_r0.loading || ctx_r0.esMio);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", ctx_r0.loading ? \"Creando...\" : \"Confirmar renta\", \" \");\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_ng_container_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵelementStart(1, \"div\", 17)(2, \"div\", 18);\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(4, RentarArticuloComponent_ng_container_10_ng_container_3_div_4_Template, 2, 2, \"div\", 19)(5, RentarArticuloComponent_ng_container_10_ng_container_3_ng_template_5_Template, 2, 2, \"ng-template\", null, 0, i0.ɵɵtemplateRefExtractor);\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(7, RentarArticuloComponent_ng_container_10_ng_container_3_div_7_Template, 2, 0, \"div\", 15)(8, RentarArticuloComponent_ng_container_10_ng_container_3_form_8_Template, 21, 9, \"form\", 20)(9, RentarArticuloComponent_ng_container_10_ng_container_3_div_9_Template, 21, 6, \"div\", 21);\n    i0.ɵɵelementContainerEnd();\n  }\n  if (rf & 2) {\n    const soloBase_r5 = i0.ɵɵreference(6);\n    const ctx_r0 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(ctx_r0.articulo.titulo);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.permiteDias || ctx_r0.permiteHoras)(\"ngIfElse\", soloBase_r5);\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.esMio);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.step === 1);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.step === 2);\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵtemplate(1, RentarArticuloComponent_ng_container_10_div_1_Template, 2, 0, \"div\", 14)(2, RentarArticuloComponent_ng_container_10_div_2_Template, 2, 1, \"div\", 15)(3, RentarArticuloComponent_ng_container_10_ng_container_3_Template, 10, 6, \"ng-container\", 7);\n    i0.ɵɵelementContainerEnd();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.loading);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", !ctx_r0.loading && ctx_r0.errorMessage);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", !ctx_r0.loading && ctx_r0.articulo);\n  }\n}\nexport let RentarArticuloComponent = /*#__PURE__*/(() => {\n  class RentarArticuloComponent {\n    constructor(route, router, fb, articuloService, authService, rentaService) {\n      this.route = route;\n      this.router = router;\n      this.fb = fb;\n      this.articuloService = articuloService;\n      this.authService = authService;\n      this.rentaService = rentaService;\n      this.loading = false;\n      this.errorMessage = '';\n      this.adminBlocked = false;\n      this.step = 1;\n      this.ocupacion = [];\n      this.articulo = null;\n      this.esMio = false;\n      this.modalidad = 'dias';\n      this.permiteHoras = false;\n      this.permiteDias = true;\n      this.form = this.fb.group({\n        fecha_inicio: ['', [Validators.required]],\n        fecha_fin: ['', [Validators.required]]\n      });\n    }\n    ngOnInit() {\n      if (this.esAdmin) {\n        this.adminBlocked = true;\n        return;\n      }\n      const id = Number(this.route.snapshot.paramMap.get('id'));\n      if (!Number.isFinite(id) || id <= 0) {\n        this.errorMessage = 'ID de artículo inválido.';\n        return;\n      }\n      this.cargarArticulo(id);\n    }\n    get esAdmin() {\n      const roles = this.authService.getRoles();\n      return roles.some(r => {\n        const v = String(r).toUpperCase();\n        return v === 'ADMIN' || v === 'ADMINISTRADOR';\n      });\n    }\n    irAExplorar() {\n      this.router.navigate(['/explorar']);\n    }\n    volverDetalle() {\n      if (!this.articulo) {\n        this.router.navigate(['/explorar']);\n        return;\n      }\n      this.router.navigate(['/articulos', this.articulo.id]);\n    }\n    confirmarRenta() {\n      if (this.adminBlocked) {\n        this.errorMessage = 'Acción no disponible para administradores.';\n        return;\n      }\n      this.errorMessage = '';\n      this.ocupacion = [];\n      if (!this.articulo) return;\n      const articuloId = this.articulo.id;\n      if (this.esMio) {\n        this.errorMessage = 'No puedes rentar tu propio artículo.';\n        return;\n      }\n      if (this.form.invalid) {\n        this.form.markAllAsTouched();\n        this.errorMessage = 'Completa las fechas.';\n        return;\n      }\n      const inicioRaw = this.form.value.fecha_inicio ?? '';\n      const finRaw = this.form.value.fecha_fin ?? '';\n      const inicio = new Date(inicioRaw);\n      const fin = new Date(finRaw);\n      if (!(inicio instanceof Date) || isNaN(inicio.getTime()) || isNaN(fin.getTime())) {\n        this.errorMessage = 'Fechas inválidas.';\n        return;\n      }\n      if (this.modalidad === 'horas') {\n        if (inicio.getMinutes() !== 0 || fin.getMinutes() !== 0) {\n          this.errorMessage = 'Solo se permiten horas exactas (sin minutos).';\n          return;\n        }\n        const diffMs = fin.getTime() - inicio.getTime();\n        if (diffMs < 60 * 60 * 1000) {\n          this.errorMessage = 'La renta por horas debe ser de al menos 1 hora.';\n          return;\n        }\n        if (diffMs % (60 * 60 * 1000) !== 0) {\n          this.errorMessage = 'Solo se permiten horas exactas (sin minutos).';\n          return;\n        }\n      }\n      if (fin <= inicio) {\n        this.errorMessage = 'La fecha fin debe ser posterior a la fecha inicio.';\n        return;\n      }\n      // Simplificación: permitir continuar sin verificación de correo/teléfono/ubicación.\n      this.continuarConfirmarRenta(articuloId, inicio, fin);\n    }\n    continuar() {\n      if (this.adminBlocked) {\n        this.errorMessage = 'Acción no disponible para administradores.';\n        return;\n      }\n      this.errorMessage = '';\n      if (!this.articulo) return;\n      if (this.esMio) {\n        this.errorMessage = 'No puedes rentar tu propio artículo.';\n        return;\n      }\n      if (this.form.invalid) {\n        this.form.markAllAsTouched();\n        this.errorMessage = 'Completa las fechas.';\n        return;\n      }\n      const inicioRaw = this.form.value.fecha_inicio ?? '';\n      const finRaw = this.form.value.fecha_fin ?? '';\n      const inicio = new Date(inicioRaw);\n      const fin = new Date(finRaw);\n      if (!(inicio instanceof Date) || isNaN(inicio.getTime()) || isNaN(fin.getTime())) {\n        this.errorMessage = 'Fechas inválidas.';\n        return;\n      }\n      if (this.modalidad === 'horas') {\n        if (inicio.getMinutes() !== 0 || fin.getMinutes() !== 0) {\n          this.errorMessage = 'Solo se permiten horas exactas (sin minutos).';\n          return;\n        }\n        const diffMs = fin.getTime() - inicio.getTime();\n        if (diffMs < 60 * 60 * 1000) {\n          this.errorMessage = 'La renta por horas debe ser de al menos 1 hora.';\n          return;\n        }\n        if (diffMs % (60 * 60 * 1000) !== 0) {\n          this.errorMessage = 'Solo se permiten horas exactas (sin minutos).';\n          return;\n        }\n      }\n      if (fin <= inicio) {\n        this.errorMessage = 'La fecha fin debe ser posterior a la fecha inicio.';\n        return;\n      }\n      this.step = 2;\n    }\n    volverPaso1() {\n      this.step = 1;\n    }\n    get unidadesEstimadas() {\n      const inicioRaw = this.form.value.fecha_inicio ?? '';\n      const finRaw = this.form.value.fecha_fin ?? '';\n      const inicio = inicioRaw ? new Date(inicioRaw) : null;\n      const fin = finRaw ? new Date(finRaw) : null;\n      if (!inicio || !fin || isNaN(inicio.getTime()) || isNaN(fin.getTime())) return 0;\n      const diffMs = fin.getTime() - inicio.getTime();\n      if (diffMs <= 0) return 0;\n      if (this.modalidad === 'horas') {\n        return Math.round(diffMs / (60 * 60 * 1000));\n      }\n      return Math.max(1, Math.ceil(diffMs / (24 * 60 * 60 * 1000)));\n    }\n    get precioUnitario() {\n      const a = this.articulo;\n      if (!a) return 0;\n      const raw = this.modalidad === 'horas' ? a.precio_renta_hora ?? a.precio_base : a.precio_renta_dia ?? a.precio_base;\n      const n = typeof raw === 'string' ? Number(raw) : raw;\n      return typeof n === 'number' && Number.isFinite(n) ? n : 0;\n    }\n    get depositoEstimado() {\n      const a = this.articulo;\n      const n = typeof a?.deposito_garantia === 'string' ? Number(a?.deposito_garantia) : a?.deposito_garantia;\n      return typeof n === 'number' && Number.isFinite(n) ? n : 0;\n    }\n    get subtotalEstimado() {\n      return this.unidadesEstimadas * this.precioUnitario;\n    }\n    get totalEstimado() {\n      return this.subtotalEstimado + this.depositoEstimado;\n    }\n    continuarConfirmarRenta(articuloId, inicio, fin) {\n      this.loading = true;\n      const toYMDLocal = d => {\n        const pad = n => String(n).padStart(2, '0');\n        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;\n      };\n      this.articuloService.getOcupacion(articuloId, toYMDLocal(inicio), toYMDLocal(fin)).subscribe({\n        next: ocupado => {\n          this.ocupacion = ocupado;\n          const overlaps = (ocupado ?? []).filter(o => {\n            const oInicio = new Date(o.inicio);\n            const oFin = new Date(o.fin);\n            if (isNaN(oInicio.getTime()) || isNaN(oFin.getTime())) return false;\n            return inicio < oFin && fin > oInicio;\n          });\n          if (overlaps.length > 0) {\n            this.loading = false;\n            this.errorMessage = 'El artículo no está disponible en el rango seleccionado.';\n            return;\n          }\n          this.rentaService.crearRenta({\n            id_articulo: articuloId,\n            fecha_inicio: inicio.toISOString(),\n            fecha_fin: fin.toISOString(),\n            modalidad: this.modalidad\n          }).subscribe({\n            next: r => {\n              this.loading = false;\n              const idRenta = r.id_renta ?? r.id;\n              this.router.navigate(['/rentas/resumen', idRenta]);\n            },\n            error: err => {\n              this.loading = false;\n              const status = err?.status;\n              const hasToken = !!this.authService.getToken();\n              if ((status === 401 || status === 422) && !hasToken) {\n                this.router.navigate(['/login']);\n                return;\n              }\n              // Sin gate modal: si backend aún rechaza por perfil incompleto, mostrar el error tal cual.\n              if (status === 403 && err?.error?.payload?.code === 'ADMIN_FORBIDDEN') {\n                this.errorMessage = 'Acción no disponible para administradores.';\n                this.adminBlocked = true;\n                return;\n              }\n              this.errorMessage = err?.error?.message || 'No se pudo crear la renta.';\n            }\n          });\n        },\n        error: err => {\n          // Si falla ocupación, no bloqueamos el flujo: dejamos que backend valide traslapes.\n          this.rentaService.crearRenta({\n            id_articulo: articuloId,\n            fecha_inicio: inicio.toISOString(),\n            fecha_fin: fin.toISOString(),\n            modalidad: this.modalidad\n          }).subscribe({\n            next: r => {\n              this.loading = false;\n              const idRenta = r.id_renta ?? r.id;\n              this.router.navigate(['/rentas/resumen', idRenta]);\n            },\n            error: err2 => {\n              this.loading = false;\n              const status = err2?.status;\n              const hasToken = !!this.authService.getToken();\n              if ((status === 401 || status === 422) && !hasToken) {\n                this.router.navigate(['/login']);\n                return;\n              }\n              // Sin gate modal: si backend aún rechaza por perfil incompleto, mostrar el error tal cual.\n              if (status === 403 && err2?.error?.payload?.code === 'ADMIN_FORBIDDEN') {\n                this.errorMessage = 'Acción no disponible para administradores.';\n                this.adminBlocked = true;\n                return;\n              }\n              this.errorMessage = err2?.error?.message || 'No se pudo crear la renta.';\n            }\n          });\n        }\n      });\n    }\n    irAPerfil() {\n      this.router.navigate(['/perfil']);\n    }\n    cargarArticulo(id) {\n      this.loading = true;\n      this.articuloService.getArticuloPorId(id).subscribe({\n        next: art => {\n          this.articulo = art;\n          const userId = this.authService.getUserId();\n          this.esMio = !!userId && Number(art?.id_propietario) === userId;\n          const precioHora = Number(art?.precio_renta_hora ?? NaN);\n          const precioDia = Number(art?.precio_renta_dia ?? NaN);\n          this.permiteHoras = Number.isFinite(precioHora) && precioHora > 0;\n          this.permiteDias = Number.isFinite(precioDia) && precioDia > 0;\n          // fallback: legacy artículos por hora sin precio_renta_hora\n          if (!this.permiteHoras && art?.unidad_precio === 'por_hora') {\n            const legacy = Number(art?.precio_renta_dia ?? NaN);\n            this.permiteHoras = Number.isFinite(legacy) && legacy > 0;\n          }\n          if (this.permiteDias) {\n            this.modalidad = 'dias';\n          } else if (this.permiteHoras) {\n            this.modalidad = 'horas';\n          } else {\n            this.modalidad = 'dias';\n          }\n          this.loading = false;\n        },\n        error: err => {\n          this.loading = false;\n          const status = err?.status;\n          const hasToken = !!this.authService.getToken();\n          if ((status === 401 || status === 422) && !hasToken) {\n            this.router.navigate(['/login']);\n            return;\n          }\n          this.errorMessage = err?.error?.message || 'No se pudo cargar el artículo.';\n        }\n      });\n    }\n    onModalidadChange(value) {\n      this.modalidad = value === 'horas' ? 'horas' : 'dias';\n      if (this.modalidad !== 'horas') return;\n      // UX: si ya hay valores, intentar llevarlos a hora exacta (minutos=00)\n      const inicioRaw = this.form.value.fecha_inicio ?? '';\n      const finRaw = this.form.value.fecha_fin ?? '';\n      const inicio = inicioRaw ? new Date(inicioRaw) : null;\n      const fin = finRaw ? new Date(finRaw) : null;\n      const roundToHour = d => {\n        const copy = new Date(d);\n        copy.setMinutes(0, 0, 0);\n        return copy;\n      };\n      const toLocalInputValue = d => {\n        const pad = n => String(n).padStart(2, '0');\n        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;\n      };\n      const patch = {};\n      if (inicio && !isNaN(inicio.getTime())) {\n        patch.fecha_inicio = toLocalInputValue(roundToHour(inicio));\n      }\n      if (fin && !isNaN(fin.getTime())) {\n        patch.fecha_fin = toLocalInputValue(roundToHour(fin));\n      }\n      if (Object.keys(patch).length > 0) {\n        this.form.patchValue(patch);\n      }\n    }\n    static {\n      this.ɵfac = function RentarArticuloComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || RentarArticuloComponent)(i0.ɵɵdirectiveInject(i1.ActivatedRoute), i0.ɵɵdirectiveInject(i1.Router), i0.ɵɵdirectiveInject(i2.FormBuilder), i0.ɵɵdirectiveInject(i3.ArticuloService), i0.ɵɵdirectiveInject(i4.AuthService), i0.ɵɵdirectiveInject(i5.RentaService));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: RentarArticuloComponent,\n        selectors: [[\"app-rentar-articulo\"]],\n        decls: 11,\n        vars: 3,\n        consts: [[\"soloBase\", \"\"], [1, \"page-wrapper\"], [1, \"card\"], [1, \"card-header\"], [\"type\", \"button\", 1, \"btn-secondary\", 3, \"click\"], [1, \"spacer\"], [\"class\", \"stepper\", 4, \"ngIf\"], [4, \"ngIf\"], [1, \"stepper\"], [1, \"step\"], [1, \"step-line\"], [1, \"step-label\"], [1, \"state-message\", \"error\"], [1, \"actions\"], [\"class\", \"state-message\", 4, \"ngIf\"], [\"class\", \"state-message error\", 4, \"ngIf\"], [1, \"state-message\"], [1, \"resumen\"], [1, \"titulo\"], [\"class\", \"precio\", 4, \"ngIf\", \"ngIfElse\"], [\"class\", \"form\", 3, \"formGroup\", \"ngSubmit\", 4, \"ngIf\"], [\"class\", \"confirm-card\", 4, \"ngIf\"], [1, \"precio\"], [1, \"form\", 3, \"ngSubmit\", \"formGroup\"], [1, \"form-grid\"], [1, \"form-row\"], [\"type\", \"datetime-local\", \"formControlName\", \"fecha_inicio\"], [\"type\", \"datetime-local\", \"formControlName\", \"fecha_fin\"], [3, \"change\", \"value\", \"disabled\"], [\"value\", \"dias\", 3, \"disabled\"], [\"value\", \"horas\", 3, \"disabled\"], [\"class\", \"hint\", 4, \"ngIf\"], [\"type\", \"submit\", 1, \"btn-primary\", 3, \"disabled\"], [1, \"hint\"], [1, \"confirm-card\"], [1, \"confirm-title\"], [1, \"confirm-grid\"], [1, \"confirm-total\"], [1, \"confirm-actions\"], [\"type\", \"button\", 1, \"btn-secondary\", 3, \"click\", \"disabled\"], [\"type\", \"button\", 1, \"btn-primary\", 3, \"click\", \"disabled\"]],\n        template: function RentarArticuloComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"div\", 1)(1, \"section\", 2)(2, \"div\", 3)(3, \"button\", 4);\n            i0.ɵɵlistener(\"click\", function RentarArticuloComponent_Template_button_click_3_listener() {\n              return ctx.volverDetalle();\n            });\n            i0.ɵɵtext(4, \"Volver\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(5, \"h2\");\n            i0.ɵɵtext(6, \"Rentar\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelement(7, \"div\", 5);\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(8, RentarArticuloComponent_div_8_Template, 8, 7, \"div\", 6)(9, RentarArticuloComponent_ng_container_9_Template, 6, 0, \"ng-container\", 7)(10, RentarArticuloComponent_ng_container_10_Template, 4, 3, \"ng-container\", 7);\n            i0.ɵɵelementEnd()();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(8);\n            i0.ɵɵproperty(\"ngIf\", !ctx.adminBlocked);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.adminBlocked);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", !ctx.adminBlocked);\n          }\n        },\n        dependencies: [i6.NgIf, i2.ɵNgNoValidate, i2.NgSelectOption, i2.ɵNgSelectMultipleOption, i2.DefaultValueAccessor, i2.NgControlStatus, i2.NgControlStatusGroup, i2.FormGroupDirective, i2.FormControlName],\n        styles: [\".card[_ngcontent-%COMP%]{max-width:900px;margin:0 auto}.stepper[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px;padding:12px 12px 0}.step[_ngcontent-%COMP%]{width:28px;height:28px;border-radius:999px;display:grid;place-items:center;border:1px solid var(--border);background:var(--surface-2);font-weight:800;color:var(--muted)}.step.active[_ngcontent-%COMP%]{color:var(--text);border-color:#14b8a673;background:#14b8a61f}.step.done[_ngcontent-%COMP%]{color:#14b8a6f2}.step-line[_ngcontent-%COMP%]{flex:0 0 34px;height:2px;background:var(--border)}.step-label[_ngcontent-%COMP%]{margin-left:auto;font-size:13px;color:var(--muted);font-weight:700}.form[_ngcontent-%COMP%] > .btn-primary[_ngcontent-%COMP%]{width:100%}.confirm-card[_ngcontent-%COMP%]{border:1px solid var(--border);border-radius:12px;background:var(--surface-2);padding:12px}.confirm-title[_ngcontent-%COMP%]{font-weight:900;margin-bottom:10px}.confirm-grid[_ngcontent-%COMP%]{display:grid;gap:8px}.confirm-total[_ngcontent-%COMP%]{font-size:16px}.confirm-actions[_ngcontent-%COMP%]{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px}.resumen[_ngcontent-%COMP%]{display:flex;align-items:baseline;justify-content:space-between;gap:10px;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--surface-2);margin-bottom:12px}.titulo[_ngcontent-%COMP%], .precio[_ngcontent-%COMP%]{font-weight:800;color:var(--text)}.form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:12px}.form-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}.form-row[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:6px}.hint[_ngcontent-%COMP%]{font-size:12px;color:var(--muted);display:flex;gap:10px}label[_ngcontent-%COMP%]{font-size:13px;font-weight:700;color:var(--text)}@media (max-width: 600px){.form-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}\"]\n      });\n    }\n  }\n  return RentarArticuloComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}