{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/sergi/OneDrive/Escritorio/micro-renta-objetos/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { Validators } from '@angular/forms';\nimport { environment } from '../../../../environments/environment';\nimport { firstValueFrom } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/forms\";\nimport * as i2 from \"../../../core/services/auth.service\";\nimport * as i3 from \"@angular/router\";\nimport * as i4 from \"@angular/common\";\nconst _c0 = [\"googleBtnHost\"];\nconst _c1 = () => ({\n  exact: true\n});\nfunction LoginComponent_div_32_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 22);\n    i0.ɵɵtext(1, \" Configura Google Sign-In para habilitar esta opci\\u00F3n. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction LoginComponent_p_33_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\", 23);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.googleErrorMessage, \" \");\n  }\n}\nfunction LoginComponent_p_34_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\", 23);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", ctx_r1.errorMessage, \" \");\n  }\n}\nexport let LoginComponent = /*#__PURE__*/(() => {\n  class LoginComponent {\n    constructor(fb, authService, router) {\n      this.fb = fb;\n      this.authService = authService;\n      this.router = router;\n      this.loading = false;\n      this.errorMessage = '';\n      this.googleReady = false;\n      this.googleLoading = false;\n      this.googleErrorMessage = '';\n      this.showGoogleHint = false;\n      this.loginForm = this.fb.group({\n        correo_electronico: ['', [Validators.required, Validators.email]],\n        contrasena: ['', [Validators.required, Validators.minLength(4)]]\n      });\n    }\n    ngAfterViewInit() {\n      // Importante: el host del botón existe después de renderizar la vista.\n      void this.initGoogleSignIn();\n    }\n    initGoogleSignIn() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        _this.googleReady = false;\n        _this.showGoogleHint = false;\n        _this.googleErrorMessage = '';\n        let clientId = String(environment.googleClientId || '').trim();\n        if (!clientId) {\n          console.warn('[Google GIS] Falta environment.googleClientId. Intentando obtenerlo desde backend...');\n          try {\n            const resp = yield firstValueFrom(_this.authService.getGoogleClientId());\n            const fromBackend = String(resp?.client_id || resp?.data?.client_id || '').trim();\n            if (fromBackend) {\n              clientId = fromBackend;\n              console.info('[Google GIS] client_id obtenido desde backend.');\n            } else {\n              console.warn('[Google GIS] Backend sin GOOGLE_CLIENT_ID configurado.');\n            }\n          } catch (e) {\n            const err = e;\n            const status = err?.status;\n            const msg = err?.error?.message || err?.message;\n            console.error('[Google GIS] No se pudo consultar client_id al backend.', {\n              status,\n              msg,\n              err\n            });\n            _this.googleErrorMessage = `No se pudo cargar Google Sign-In: backend respondió ${status ?? 'error'}`;\n            _this.showGoogleHint = true;\n          }\n        }\n        if (!clientId) {\n          // No fatal: login normal sigue funcionando.\n          _this.showGoogleHint = true;\n          console.warn('[Google GIS] Google Sign-In deshabilitado: client_id vacío.');\n          return;\n        }\n        // Esperar a que cargue el script GIS (lo añadimos en index.html)\n        const start = Date.now();\n        const wait = () => {\n          const g = window.google;\n          if (g?.accounts?.id) {\n            try {\n              console.info('[Google GIS] Script cargado. Inicializando...');\n              g.accounts.id.initialize({\n                client_id: clientId,\n                callback: resp => {\n                  const credential = String(resp?.credential || '').trim();\n                  if (!credential) {\n                    console.error('[Google GIS] Callback sin credential.', resp);\n                    _this.googleErrorMessage = 'No se pudo obtener credenciales de Google.';\n                    return;\n                  }\n                  _this.handleGoogleCredential(credential);\n                },\n                auto_select: false,\n                cancel_on_tap_outside: true,\n                context: 'signin',\n                locale: 'es'\n              });\n              const el = _this.googleBtnHost?.nativeElement || document.getElementById('googleBtn');\n              if (!el) {\n                console.error('[Google GIS] No existe el contenedor #googleBtnHost/#googleBtn.');\n                // Tratamos como hint de configuración para mantener el mensaje actual.\n                _this.showGoogleHint = true;\n                return;\n              }\n              // Renderiza el botón oficial de Google (GIS)\n              g.accounts.id.renderButton(el, {\n                theme: 'outline',\n                size: 'large',\n                text: 'continue_with',\n                shape: 'pill'\n              });\n              _this.googleReady = true;\n              _this.showGoogleHint = false;\n              console.info('[Google GIS] Botón renderizado OK.');\n            } catch (e) {\n              console.error('[Google GIS] Error inicializando/renderizando.', e);\n              _this.googleReady = false;\n              // Para cumplir el criterio: si falla GIS, mostrar el mensaje actual.\n              _this.showGoogleHint = true;\n            }\n            return;\n          }\n          if (Date.now() - start > 8000) {\n            _this.googleReady = false;\n            _this.showGoogleHint = true;\n            console.error('[Google GIS] Script no cargó (timeout). Verifica index.html y conexión a accounts.google.com.');\n            return;\n          }\n          setTimeout(wait, 80);\n        };\n        wait();\n      })();\n    }\n    handleGoogleCredential(idToken) {\n      if (this.googleLoading) return;\n      this.googleLoading = true;\n      this.googleErrorMessage = '';\n      console.info('[Google GIS] Enviando id_token al backend /api/auth/google...');\n      this.authService.loginWithGoogle(idToken).subscribe({\n        next: () => {\n          this.googleLoading = false;\n          console.info('[Google GIS] Login backend OK. Redirigiendo a /explorar.');\n          this.router.navigate(['/explorar']);\n        },\n        error: err => {\n          console.error('[Google GIS] Error en login backend', err);\n          this.googleLoading = false;\n          const msg = err?.error?.message;\n          this.googleErrorMessage = typeof msg === 'string' && msg.trim() ? msg : 'No se pudo iniciar sesión con Google.';\n        }\n      });\n    }\n    onSubmit() {\n      if (this.loginForm.invalid || this.loading) {\n        return;\n      }\n      this.loading = true;\n      this.errorMessage = '';\n      const {\n        correo_electronico,\n        contrasena\n      } = this.loginForm.value;\n      this.authService.login(correo_electronico, contrasena).subscribe({\n        next: resp => {\n          console.log('Login OK', resp);\n          this.loading = false;\n          // Aquí ya se guardó el token en el AuthService (localStorage)\n          // Redirigimos a la siguiente pantalla (ajusta la ruta a lo que quieras)\n          this.router.navigate(['/explorar']);\n        },\n        error: err => {\n          console.error('Error en login', err);\n          this.loading = false;\n          this.errorMessage = 'Error al iniciar sesión. Verifica tus datos.';\n        }\n      });\n    }\n    static {\n      this.ɵfac = function LoginComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || LoginComponent)(i0.ɵɵdirectiveInject(i1.FormBuilder), i0.ɵɵdirectiveInject(i2.AuthService), i0.ɵɵdirectiveInject(i3.Router));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: LoginComponent,\n        selectors: [[\"app-login\"]],\n        viewQuery: function LoginComponent_Query(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵviewQuery(_c0, 5);\n          }\n          if (rf & 2) {\n            let _t;\n            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.googleBtnHost = _t.first);\n          }\n        },\n        decls: 35,\n        vars: 12,\n        consts: [[\"googleBtnHost\", \"\"], [1, \"auth-container\"], [1, \"auth-card\"], [1, \"auth-logo\"], [\"src\", \"assets/brand/logo_renta.jpg\", \"alt\", \"DentalCare\"], [1, \"auth-brand\"], [1, \"auth-brand-text\"], [1, \"auth-name\"], [1, \"auth-slogan\"], [\"role\", \"tablist\", \"aria-label\", \"Acceso\", 1, \"auth-tabs\"], [\"routerLink\", \"/login\", \"routerLinkActive\", \"active\", 1, \"auth-tab\", 3, \"routerLinkActiveOptions\"], [\"routerLink\", \"/register\", \"routerLinkActive\", \"active\", 1, \"auth-tab\", 3, \"routerLinkActiveOptions\"], [3, \"ngSubmit\", \"formGroup\"], [\"type\", \"email\", \"formControlName\", \"correo_electronico\", \"placeholder\", \"tu@correo.com\"], [\"type\", \"password\", \"formControlName\", \"contrasena\", \"placeholder\", \"\\u2022\\u2022\\u2022\\u2022\\u2022\\u2022\\u2022\\u2022\"], [\"type\", \"submit\", 3, \"disabled\"], [\"aria-hidden\", \"true\", 1, \"auth-sep\"], [1, \"auth-sep-text\"], [1, \"auth-google-wrap\"], [\"id\", \"googleBtn\", \"aria-label\", \"Continuar con Google\", 1, \"auth-google-host\"], [\"class\", \"auth-google-hint\", 4, \"ngIf\"], [\"class\", \"error-msg\", 4, \"ngIf\"], [1, \"auth-google-hint\"], [1, \"error-msg\"]],\n        template: function LoginComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            const _r1 = i0.ɵɵgetCurrentView();\n            i0.ɵɵelementStart(0, \"div\", 1)(1, \"div\", 2)(2, \"div\", 3);\n            i0.ɵɵelement(3, \"img\", 4);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(4, \"div\", 5)(5, \"div\", 6)(6, \"div\", 7);\n            i0.ɵɵtext(7, \"Micro Renta\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(8, \"div\", 8);\n            i0.ɵɵtext(9, \"Renta objetos cerca de ti, en minutos.\");\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵelementStart(10, \"div\", 9)(11, \"a\", 10);\n            i0.ɵɵtext(12, \"Iniciar sesi\\u00F3n\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(13, \"a\", 11);\n            i0.ɵɵtext(14, \"Registrarse\");\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(15, \"form\", 12);\n            i0.ɵɵlistener(\"ngSubmit\", function LoginComponent_Template_form_ngSubmit_15_listener() {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.onSubmit());\n            });\n            i0.ɵɵelementStart(16, \"label\");\n            i0.ɵɵtext(17, \" Correo electr\\u00F3nico \");\n            i0.ɵɵelement(18, \"input\", 13);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(19, \"label\");\n            i0.ɵɵtext(20, \" Contrase\\u00F1a \");\n            i0.ɵɵelement(21, \"input\", 14);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(22, \"button\", 15);\n            i0.ɵɵtext(23);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(24, \"div\", 16);\n            i0.ɵɵelement(25, \"span\");\n            i0.ɵɵelementStart(26, \"div\", 17);\n            i0.ɵɵtext(27, \"o\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelement(28, \"span\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(29, \"div\", 18);\n            i0.ɵɵelement(30, \"div\", 19, 0);\n            i0.ɵɵtemplate(32, LoginComponent_div_32_Template, 2, 0, \"div\", 20);\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(33, LoginComponent_p_33_Template, 2, 1, \"p\", 21)(34, LoginComponent_p_34_Template, 2, 1, \"p\", 21);\n            i0.ɵɵelementEnd()()();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(11);\n            i0.ɵɵproperty(\"routerLinkActiveOptions\", i0.ɵɵpureFunction0(10, _c1));\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"routerLinkActiveOptions\", i0.ɵɵpureFunction0(11, _c1));\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"formGroup\", ctx.loginForm);\n            i0.ɵɵadvance(7);\n            i0.ɵɵproperty(\"disabled\", ctx.loginForm.invalid || ctx.loading);\n            i0.ɵɵadvance();\n            i0.ɵɵtextInterpolate1(\" \", ctx.loading ? \"Ingresando...\" : \"Entrar\", \" \");\n            i0.ɵɵadvance(6);\n            i0.ɵɵclassProp(\"is-loading\", ctx.googleLoading);\n            i0.ɵɵadvance(3);\n            i0.ɵɵproperty(\"ngIf\", ctx.showGoogleHint);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.googleErrorMessage);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.errorMessage);\n          }\n        },\n        dependencies: [i4.NgIf, i1.ɵNgNoValidate, i1.DefaultValueAccessor, i1.NgControlStatus, i1.NgControlStatusGroup, i1.FormGroupDirective, i1.FormControlName, i3.RouterLink, i3.RouterLinkActive],\n        styles: [\".auth-container[_ngcontent-%COMP%]{min-height:100vh;display:flex;justify-content:center;align-items:center;padding:var(--space-3) var(--space-2);background:var(--color-bg)}.auth-card[_ngcontent-%COMP%]{background:var(--color-surface);border:1px solid var(--color-border);border-radius:18px;box-shadow:var(--shadow-2);max-width:420px;width:100%;padding:20px}@media (min-width: 520px){.auth-card[_ngcontent-%COMP%]{padding:28px}}.auth-logo[_ngcontent-%COMP%]{display:flex;justify-content:center;margin-bottom:20px}.auth-logo[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{height:78px;width:auto;object-fit:contain;display:block}@media (max-width: 420px){.auth-logo[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{height:64px}}.auth-brand[_ngcontent-%COMP%]{display:flex;justify-content:center;text-align:center;margin-bottom:14px}.auth-name[_ngcontent-%COMP%]{font-size:18px;font-weight:900;letter-spacing:-.02em;color:var(--color-text)}.auth-slogan[_ngcontent-%COMP%]{margin-top:2px;font-size:13px;color:var(--color-muted);font-weight:650}.auth-tabs[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0 16px}.auth-tab[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;min-height:44px;border-radius:var(--radius-pill);border:1px solid var(--color-border);background:#0f172a08;color:var(--color-text);font-weight:850;text-decoration:none;transition:background .16s ease,border-color .16s ease}.auth-tab[_ngcontent-%COMP%]:hover{background:#0f172a0d;border-color:var(--color-border-strong);text-decoration:none}.auth-tab.active[_ngcontent-%COMP%]{background:#14b8a61f;border-color:#14b8a659}form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:12px}label[_ngcontent-%COMP%]{font-size:13px;color:var(--color-text)}.auth-card[_ngcontent-%COMP%]   button[type=submit][_ngcontent-%COMP%]{margin-top:6px;width:100%;border-radius:14px;border:1px solid rgba(20,184,166,.22);background:var(--color-primary);color:#062a28;min-height:48px;padding:12px 14px;font-weight:800}.auth-card[_ngcontent-%COMP%]   button[type=submit][_ngcontent-%COMP%]:hover{background:var(--color-primary-600)}.error-msg[_ngcontent-%COMP%]{margin-top:8px;font-size:13px;color:#7f1d1d;text-align:left;background:var(--color-danger-bg);border:1px solid rgba(239,68,68,.18);padding:10px 12px;border-radius:14px}.auth-sep[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;margin:4px 0 0}.auth-sep[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{height:1px;background:#0f172a1a}.auth-sep-text[_ngcontent-%COMP%]{font-size:12px;color:var(--color-muted);font-weight:800;text-transform:uppercase;letter-spacing:.06em}.auth-google-wrap[_ngcontent-%COMP%]{width:100%;display:grid;gap:8px}.auth-google-wrap.is-loading[_ngcontent-%COMP%]{opacity:.65;pointer-events:none}.auth-google-host[_ngcontent-%COMP%]{width:100%;min-height:48px;display:flex;align-items:center;justify-content:center}.auth-google-hint[_ngcontent-%COMP%]{font-size:12px;color:var(--color-muted);font-weight:700}.link[_ngcontent-%COMP%]{margin:14px 0 0;color:var(--color-muted);font-size:13px}.link[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{font-weight:800}\"]\n      });\n    }\n  }\n  return LoginComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}