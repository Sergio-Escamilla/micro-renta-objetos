{"ast":null,"code":"import { Validators } from '@angular/forms';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nimport * as i2 from \"@angular/forms\";\nimport * as i3 from \"src/app/core/services/articulo.service\";\nimport * as i4 from \"src/app/core/services/auth.service\";\nimport * as i5 from \"src/app/core/services/renta.service\";\nimport * as i6 from \"@angular/common\";\nfunction RentarArticuloComponent_div_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 8);\n    i0.ɵɵtext(1, \"Cargando...\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction RentarArticuloComponent_div_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 9);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(ctx_r0.errorMessage);\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_div_6_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 9);\n    i0.ɵɵtext(1, \" No puedes rentar tu propio art\\u00EDculo. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction RentarArticuloComponent_ng_container_10_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r2 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵelementStart(1, \"div\", 10)(2, \"div\", 11);\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"div\", 12);\n    i0.ɵɵtext(5);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵtemplate(6, RentarArticuloComponent_ng_container_10_div_6_Template, 2, 0, \"div\", 6);\n    i0.ɵɵelementStart(7, \"form\", 13);\n    i0.ɵɵlistener(\"ngSubmit\", function RentarArticuloComponent_ng_container_10_Template_form_ngSubmit_7_listener() {\n      i0.ɵɵrestoreView(_r2);\n      const ctx_r0 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r0.confirmarRenta());\n    });\n    i0.ɵɵelementStart(8, \"div\", 14)(9, \"div\", 15)(10, \"label\");\n    i0.ɵɵtext(11, \"Inicio\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(12, \"input\", 16);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(13, \"div\", 15)(14, \"label\");\n    i0.ɵɵtext(15, \"Fin\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(16, \"input\", 17);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(17, \"div\", 15)(18, \"label\");\n    i0.ɵɵtext(19, \"Modalidad\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(20, \"select\", 18);\n    i0.ɵɵlistener(\"change\", function RentarArticuloComponent_ng_container_10_Template_select_change_20_listener($event) {\n      i0.ɵɵrestoreView(_r2);\n      const ctx_r0 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r0.onModalidadChange($event.target.value));\n    });\n    i0.ɵɵelementStart(21, \"option\", 19);\n    i0.ɵɵtext(22, \"D\\u00EDas\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(23, \"option\", 20);\n    i0.ɵɵtext(24, \"Horas\");\n    i0.ɵɵelementEnd()()()();\n    i0.ɵɵelementStart(25, \"button\", 21);\n    i0.ɵɵtext(26);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementContainerEnd();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(ctx_r0.articulo.titulo);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate2(\" $\", ctx_r0.articulo.precio_renta_dia, \" / \", ctx_r0.modalidad === \"horas\" ? \"hora\" : \"d\\u00EDa\", \" \");\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.esMio);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"formGroup\", ctx_r0.form);\n    i0.ɵɵadvance(5);\n    i0.ɵɵattribute(\"step\", ctx_r0.modalidad === \"horas\" ? 3600 : 60);\n    i0.ɵɵadvance(4);\n    i0.ɵɵattribute(\"step\", ctx_r0.modalidad === \"horas\" ? 3600 : 60);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"value\", ctx_r0.modalidad)(\"disabled\", ctx_r0.loading);\n    i0.ɵɵadvance(5);\n    i0.ɵɵproperty(\"disabled\", ctx_r0.loading || ctx_r0.esMio);\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \", ctx_r0.loading ? \"Creando...\" : \"Confirmar renta\", \" \");\n  }\n}\nexport let RentarArticuloComponent = /*#__PURE__*/(() => {\n  class RentarArticuloComponent {\n    constructor(route, router, fb, articuloService, authService, rentaService) {\n      this.route = route;\n      this.router = router;\n      this.fb = fb;\n      this.articuloService = articuloService;\n      this.authService = authService;\n      this.rentaService = rentaService;\n      this.loading = false;\n      this.errorMessage = '';\n      this.articulo = null;\n      this.esMio = false;\n      this.modalidad = 'dias';\n      this.form = this.fb.group({\n        fecha_inicio: ['', [Validators.required]],\n        fecha_fin: ['', [Validators.required]]\n      });\n    }\n    ngOnInit() {\n      const id = Number(this.route.snapshot.paramMap.get('id'));\n      if (!Number.isFinite(id) || id <= 0) {\n        this.errorMessage = 'ID de artículo inválido.';\n        return;\n      }\n      this.cargarArticulo(id);\n    }\n    volverDetalle() {\n      if (!this.articulo) {\n        this.router.navigate(['/explorar']);\n        return;\n      }\n      this.router.navigate(['/articulos', this.articulo.id]);\n    }\n    confirmarRenta() {\n      this.errorMessage = '';\n      if (!this.articulo) return;\n      if (this.esMio) {\n        this.errorMessage = 'No puedes rentar tu propio artículo.';\n        return;\n      }\n      if (this.form.invalid) {\n        this.form.markAllAsTouched();\n        this.errorMessage = 'Completa las fechas.';\n        return;\n      }\n      const inicioRaw = this.form.value.fecha_inicio ?? '';\n      const finRaw = this.form.value.fecha_fin ?? '';\n      const inicio = new Date(inicioRaw);\n      const fin = new Date(finRaw);\n      if (!(inicio instanceof Date) || isNaN(inicio.getTime()) || isNaN(fin.getTime())) {\n        this.errorMessage = 'Fechas inválidas.';\n        return;\n      }\n      if (this.modalidad === 'horas') {\n        if (inicio.getMinutes() !== 0 || fin.getMinutes() !== 0) {\n          this.errorMessage = 'Solo se permiten horas exactas (sin minutos).';\n          return;\n        }\n        const diffMs = fin.getTime() - inicio.getTime();\n        if (diffMs < 60 * 60 * 1000) {\n          this.errorMessage = 'La renta por horas debe ser de al menos 1 hora.';\n          return;\n        }\n        if (diffMs % (60 * 60 * 1000) !== 0) {\n          this.errorMessage = 'Solo se permiten horas exactas (sin minutos).';\n          return;\n        }\n      }\n      if (fin <= inicio) {\n        this.errorMessage = 'La fecha fin debe ser posterior a la fecha inicio.';\n        return;\n      }\n      this.loading = true;\n      this.rentaService.crearRenta({\n        id_articulo: this.articulo.id,\n        fecha_inicio: inicio.toISOString(),\n        fecha_fin: fin.toISOString(),\n        modalidad: this.modalidad\n      }).subscribe({\n        next: r => {\n          this.loading = false;\n          const idRenta = r.id_renta ?? r.id;\n          this.router.navigate(['/rentas/resumen', idRenta]);\n        },\n        error: err => {\n          this.loading = false;\n          const status = err?.status;\n          const hasToken = !!this.authService.getToken();\n          if ((status === 401 || status === 422) && !hasToken) {\n            this.router.navigate(['/login']);\n            return;\n          }\n          this.errorMessage = err?.error?.message || 'No se pudo crear la renta.';\n        }\n      });\n    }\n    cargarArticulo(id) {\n      this.loading = true;\n      this.articuloService.getArticuloPorId(id).subscribe({\n        next: art => {\n          this.articulo = art;\n          const userId = this.authService.getUserId();\n          this.esMio = !!userId && Number(art?.id_propietario) === userId;\n          const unidad = art?.unidad_precio;\n          this.modalidad = unidad === 'por_hora' ? 'horas' : 'dias';\n          this.loading = false;\n        },\n        error: err => {\n          this.loading = false;\n          const status = err?.status;\n          const hasToken = !!this.authService.getToken();\n          if ((status === 401 || status === 422) && !hasToken) {\n            this.router.navigate(['/login']);\n            return;\n          }\n          this.errorMessage = err?.error?.message || 'No se pudo cargar el artículo.';\n        }\n      });\n    }\n    onModalidadChange(value) {\n      this.modalidad = value === 'horas' ? 'horas' : 'dias';\n      if (this.modalidad !== 'horas') return;\n      // UX: si ya hay valores, intentar llevarlos a hora exacta (minutos=00)\n      const inicioRaw = this.form.value.fecha_inicio ?? '';\n      const finRaw = this.form.value.fecha_fin ?? '';\n      const inicio = inicioRaw ? new Date(inicioRaw) : null;\n      const fin = finRaw ? new Date(finRaw) : null;\n      const roundToHour = d => {\n        const copy = new Date(d);\n        copy.setMinutes(0, 0, 0);\n        return copy;\n      };\n      const toLocalInputValue = d => {\n        const pad = n => String(n).padStart(2, '0');\n        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;\n      };\n      const patch = {};\n      if (inicio && !isNaN(inicio.getTime())) {\n        patch.fecha_inicio = toLocalInputValue(roundToHour(inicio));\n      }\n      if (fin && !isNaN(fin.getTime())) {\n        patch.fecha_fin = toLocalInputValue(roundToHour(fin));\n      }\n      if (Object.keys(patch).length > 0) {\n        this.form.patchValue(patch);\n      }\n    }\n    static {\n      this.ɵfac = function RentarArticuloComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || RentarArticuloComponent)(i0.ɵɵdirectiveInject(i1.ActivatedRoute), i0.ɵɵdirectiveInject(i1.Router), i0.ɵɵdirectiveInject(i2.FormBuilder), i0.ɵɵdirectiveInject(i3.ArticuloService), i0.ɵɵdirectiveInject(i4.AuthService), i0.ɵɵdirectiveInject(i5.RentaService));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: RentarArticuloComponent,\n        selectors: [[\"app-rentar-articulo\"]],\n        decls: 11,\n        vars: 3,\n        consts: [[1, \"page-wrapper\"], [1, \"card\"], [1, \"card-header\"], [\"type\", \"button\", 1, \"btn-secondary\", 3, \"click\"], [1, \"spacer\"], [\"class\", \"state-message\", 4, \"ngIf\"], [\"class\", \"state-message error\", 4, \"ngIf\"], [4, \"ngIf\"], [1, \"state-message\"], [1, \"state-message\", \"error\"], [1, \"resumen\"], [1, \"titulo\"], [1, \"precio\"], [1, \"form\", 3, \"ngSubmit\", \"formGroup\"], [1, \"form-grid\"], [1, \"form-row\"], [\"type\", \"datetime-local\", \"formControlName\", \"fecha_inicio\"], [\"type\", \"datetime-local\", \"formControlName\", \"fecha_fin\"], [3, \"change\", \"value\", \"disabled\"], [\"value\", \"dias\"], [\"value\", \"horas\"], [\"type\", \"submit\", 1, \"btn-primary\", 3, \"disabled\"]],\n        template: function RentarArticuloComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"div\", 0)(1, \"section\", 1)(2, \"div\", 2)(3, \"button\", 3);\n            i0.ɵɵlistener(\"click\", function RentarArticuloComponent_Template_button_click_3_listener() {\n              return ctx.volverDetalle();\n            });\n            i0.ɵɵtext(4, \"Volver\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(5, \"h2\");\n            i0.ɵɵtext(6, \"Rentar\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelement(7, \"div\", 4);\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(8, RentarArticuloComponent_div_8_Template, 2, 0, \"div\", 5)(9, RentarArticuloComponent_div_9_Template, 2, 1, \"div\", 6)(10, RentarArticuloComponent_ng_container_10_Template, 27, 11, \"ng-container\", 7);\n            i0.ɵɵelementEnd()();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(8);\n            i0.ɵɵproperty(\"ngIf\", ctx.loading);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", !ctx.loading && ctx.errorMessage);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", !ctx.loading && !ctx.errorMessage && ctx.articulo);\n          }\n        },\n        dependencies: [i6.NgIf, i2.ɵNgNoValidate, i2.NgSelectOption, i2.ɵNgSelectMultipleOption, i2.DefaultValueAccessor, i2.NgControlStatus, i2.NgControlStatusGroup, i2.FormGroupDirective, i2.FormControlName],\n        styles: [\".page-wrapper[_ngcontent-%COMP%]{padding:24px}.card[_ngcontent-%COMP%]{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;max-width:900px;margin:0 auto}.card-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;margin-bottom:12px}.card-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:18px;font-weight:800}.spacer[_ngcontent-%COMP%]{flex:1}.btn-secondary[_ngcontent-%COMP%]{background:#f3f4f6;border:1px solid #e5e7eb;color:#111827;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}.btn-primary[_ngcontent-%COMP%]{background:#111827;color:#fff;border:1px solid transparent;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer;width:100%}.state-message[_ngcontent-%COMP%]{padding:12px;border-radius:10px;background:#f9fafb;border:1px solid #f3f4f6;color:#374151;margin:10px 0}.state-message.error[_ngcontent-%COMP%]{background:#fef2f2;border-color:#fee2e2;color:#991b1b}.resumen[_ngcontent-%COMP%]{display:flex;align-items:baseline;justify-content:space-between;gap:10px;padding:12px;border:1px solid #f3f4f6;border-radius:12px;margin-bottom:12px}.titulo[_ngcontent-%COMP%], .precio[_ngcontent-%COMP%]{font-weight:800;color:#111827}.form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:12px}.form-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}.form-row[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:6px}label[_ngcontent-%COMP%]{font-size:13px;font-weight:700;color:#111827}input[_ngcontent-%COMP%]{border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;font-size:14px}@media (max-width: 600px){.page-wrapper[_ngcontent-%COMP%]{padding:16px}.form-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}\"]\n      });\n    }\n  }\n  return RentarArticuloComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}