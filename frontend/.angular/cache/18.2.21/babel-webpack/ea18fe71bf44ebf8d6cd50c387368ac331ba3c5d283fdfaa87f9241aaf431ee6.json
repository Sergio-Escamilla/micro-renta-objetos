{"ast":null,"code":"import { catchError, finalize, forkJoin, of } from 'rxjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app/core/services/renta.service\";\nimport * as i2 from \"@angular/router\";\nimport * as i3 from \"@angular/common\";\nfunction InboxComponent_div_13_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 11)(1, \"button\", 12);\n    i0.ɵɵlistener(\"click\", function InboxComponent_div_13_Template_button_click_1_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.cambiarRolHistorial(\"dueno\"));\n    });\n    i0.ɵɵtext(2, \" Due\\u00F1o \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"button\", 12);\n    i0.ɵɵlistener(\"click\", function InboxComponent_div_13_Template_button_click_3_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.cambiarRolHistorial(\"arrendatario\"));\n    });\n    i0.ɵɵtext(4, \" Arrendatario \");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵclassProp(\"active\", ctx_r1.rolHistorial === \"dueno\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵclassProp(\"active\", ctx_r1.rolHistorial === \"arrendatario\");\n  }\n}\nfunction InboxComponent_div_14_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 13);\n    i0.ɵɵtext(1, \"Cargando...\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction InboxComponent_div_15_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 14);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(ctx_r1.errorMessage);\n  }\n}\nfunction InboxComponent_div_16_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 13);\n    i0.ɵɵtext(1, \" No hay rentas para mostrar. \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction InboxComponent_div_17_article_1_ng_container_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵelement(1, \"img\", 29);\n    i0.ɵɵelementContainerEnd();\n  }\n  if (rf & 2) {\n    const r_r4 = i0.ɵɵnextContext().$implicit;\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"src\", r_r4.articulo == null ? null : r_r4.articulo.imagen, i0.ɵɵsanitizeUrl)(\"alt\", (r_r4.articulo == null ? null : r_r4.articulo.titulo) || \"Art\\u00EDculo\");\n  }\n}\nfunction InboxComponent_div_17_article_1_ng_template_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"div\", 30);\n  }\n}\nfunction InboxComponent_div_17_article_1_span_17_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const r_r4 = i0.ɵɵnextContext().$implicit;\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \\u00B7 Total: $\", r_r4.total, \"\");\n  }\n}\nfunction InboxComponent_div_17_article_1_span_18_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"span\");\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const r_r4 = i0.ɵɵnextContext().$implicit;\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\" \\u00B7 Dep\\u00F3sito: $\", r_r4.deposito, \"\");\n  }\n}\nfunction InboxComponent_div_17_article_1_div_20_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 31)(1, \"span\", 32);\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"span\", 33);\n    i0.ɵɵtext(4, \"sin leer\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const r_r4 = i0.ɵɵnextContext().$implicit;\n    const ctx_r1 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(ctx_r1.unread(r_r4.id_renta));\n  }\n}\nfunction InboxComponent_div_17_article_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r3 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"article\", 17)(1, \"div\", 18);\n    i0.ɵɵtemplate(2, InboxComponent_div_17_article_1_ng_container_2_Template, 2, 2, \"ng-container\", 19)(3, InboxComponent_div_17_article_1_ng_template_3_Template, 1, 0, \"ng-template\", null, 0, i0.ɵɵtemplateRefExtractor);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"div\", 20)(6, \"div\", 21)(7, \"div\", 22);\n    i0.ɵɵtext(8);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(9, \"span\", 23);\n    i0.ɵɵtext(10);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(11, \"div\", 24);\n    i0.ɵɵtext(12);\n    i0.ɵɵpipe(13, \"date\");\n    i0.ɵɵpipe(14, \"date\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(15, \"div\", 24);\n    i0.ɵɵtext(16);\n    i0.ɵɵtemplate(17, InboxComponent_div_17_article_1_span_17_Template, 2, 1, \"span\", 25)(18, InboxComponent_div_17_article_1_span_18_Template, 2, 1, \"span\", 25);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(19, \"div\", 26);\n    i0.ɵɵtemplate(20, InboxComponent_div_17_article_1_div_20_Template, 5, 1, \"div\", 27);\n    i0.ɵɵelement(21, \"div\", 4);\n    i0.ɵɵelementStart(22, \"button\", 28);\n    i0.ɵɵlistener(\"click\", function InboxComponent_div_17_article_1_Template_button_click_22_listener() {\n      const r_r4 = i0.ɵɵrestoreView(_r3).$implicit;\n      const ctx_r1 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r1.verResumen(r_r4.id_renta));\n    });\n    i0.ɵɵtext(23, \" Abrir \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(24, \"button\", 12);\n    i0.ɵɵlistener(\"click\", function InboxComponent_div_17_article_1_Template_button_click_24_listener() {\n      const r_r4 = i0.ɵɵrestoreView(_r3).$implicit;\n      const ctx_r1 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r1.abrirChat(r_r4.id_renta));\n    });\n    i0.ɵɵtext(25, \" Chat \");\n    i0.ɵɵelementEnd()()()();\n  }\n  if (rf & 2) {\n    const r_r4 = ctx.$implicit;\n    const placeholder_r5 = i0.ɵɵreference(4);\n    const ctx_r1 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", r_r4.articulo == null ? null : r_r4.articulo.imagen)(\"ngIfElse\", placeholder_r5);\n    i0.ɵɵadvance(6);\n    i0.ɵɵtextInterpolate((r_r4.articulo == null ? null : r_r4.articulo.titulo) || \"Art\\u00EDculo\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(r_r4.estado);\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate2(\" \", i0.ɵɵpipeBind2(13, 10, r_r4.fechas == null ? null : r_r4.fechas.inicio, \"short\"), \" \\u2192 \", i0.ɵɵpipeBind2(14, 13, r_r4.fechas == null ? null : r_r4.fechas.fin, \"short\"), \" \");\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate1(\" \", r_r4.modalidad || \"-\", \" \");\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", r_r4.total != null);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", r_r4.deposito != null);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", ctx_r1.unread(r_r4.id_renta) > 0);\n  }\n}\nfunction InboxComponent_div_17_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 15);\n    i0.ɵɵtemplate(1, InboxComponent_div_17_article_1_Template, 26, 16, \"article\", 16);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngForOf\", ctx_r1.items);\n  }\n}\nexport let InboxComponent = /*#__PURE__*/(() => {\n  class InboxComponent {\n    constructor(rentaService, router) {\n      this.rentaService = rentaService;\n      this.router = router;\n      this.loading = false;\n      this.errorMessage = '';\n      this.selectedTab = 'dueno_activas';\n      this.rolHistorial = 'dueno';\n      this.items = [];\n      this.unreadByRentaId = {};\n    }\n    ngOnInit() {\n      this.cargarTab('dueno_activas');\n    }\n    cargarTab(tab) {\n      this.selectedTab = tab;\n      this.errorMessage = '';\n      this.items = [];\n      this.unreadByRentaId = {};\n      let rol = 'dueno';\n      let estado = 'activas';\n      if (tab === 'dueno_activas') {\n        rol = 'dueno';\n        estado = 'activas';\n        this.rolHistorial = 'dueno';\n      } else if (tab === 'arrendatario_activas') {\n        rol = 'arrendatario';\n        estado = 'activas';\n        this.rolHistorial = 'arrendatario';\n      } else {\n        rol = this.rolHistorial;\n        estado = 'historial';\n      }\n      this.loading = true;\n      this.rentaService.misRentas(rol, estado, 1, 20).pipe(finalize(() => {\n        this.loading = false;\n      })).subscribe({\n        next: data => {\n          this.items = data?.items ?? [];\n          if (estado === 'activas') {\n            this.cargarUnreads(this.items);\n          }\n        },\n        error: err => {\n          this.errorMessage = err?.error?.message || 'No se pudo cargar la bandeja.';\n        }\n      });\n    }\n    cambiarRolHistorial(rol) {\n      this.rolHistorial = rol;\n      if (this.selectedTab === 'historial') {\n        this.cargarTab('historial');\n      }\n    }\n    cargarUnreads(items) {\n      const list = (items ?? []).slice(0, 20);\n      if (!list.length) return;\n      const calls = list.map(it => this.rentaService.chatUnreadCount(it.id_renta).pipe(catchError(() => of(0))));\n      forkJoin(calls).subscribe(counts => {\n        const map = {};\n        for (let i = 0; i < list.length; i++) {\n          map[list[i].id_renta] = Number(counts[i] ?? 0) || 0;\n        }\n        this.unreadByRentaId = map;\n      });\n    }\n    unread(idRenta) {\n      return Number(this.unreadByRentaId?.[idRenta] ?? 0) || 0;\n    }\n    verResumen(idRenta) {\n      this.router.navigate(['/rentas/resumen', idRenta]);\n    }\n    abrirChat(idRenta) {\n      this.router.navigate(['/rentas/resumen', idRenta], {\n        queryParams: {\n          chat: 1\n        },\n        fragment: 'chat'\n      });\n    }\n    static {\n      this.ɵfac = function InboxComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || InboxComponent)(i0.ɵɵdirectiveInject(i1.RentaService), i0.ɵɵdirectiveInject(i2.Router));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: InboxComponent,\n        selectors: [[\"app-inbox\"]],\n        decls: 18,\n        vars: 11,\n        consts: [[\"placeholder\", \"\"], [1, \"page-wrapper\"], [1, \"card\"], [1, \"card-header\"], [1, \"spacer\"], [1, \"tabs\"], [\"type\", \"button\", 1, \"tab\", 3, \"click\"], [\"class\", \"historial-rol\", 4, \"ngIf\"], [\"class\", \"state-message\", 4, \"ngIf\"], [\"class\", \"state-message error\", 4, \"ngIf\"], [\"class\", \"grid\", 4, \"ngIf\"], [1, \"historial-rol\"], [\"type\", \"button\", 1, \"btn-secondary\", 3, \"click\"], [1, \"state-message\"], [1, \"state-message\", \"error\"], [1, \"grid\"], [\"class\", \"item\", 4, \"ngFor\", \"ngForOf\"], [1, \"item\"], [1, \"media\"], [4, \"ngIf\", \"ngIfElse\"], [1, \"content\"], [1, \"title-row\"], [1, \"titulo\"], [1, \"badge\"], [1, \"sub\"], [4, \"ngIf\"], [1, \"actions\"], [\"class\", \"unread\", 4, \"ngIf\"], [\"type\", \"button\", 1, \"btn-primary\", 3, \"click\"], [1, \"img\", 3, \"src\", \"alt\"], [1, \"img\", \"placeholder\"], [1, \"unread\"], [1, \"unread-badge\"], [1, \"unread-text\"]],\n        template: function InboxComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"div\", 1)(1, \"section\", 2)(2, \"div\", 3)(3, \"h2\");\n            i0.ɵɵtext(4, \"Bandeja\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelement(5, \"div\", 4);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(6, \"div\", 5)(7, \"button\", 6);\n            i0.ɵɵlistener(\"click\", function InboxComponent_Template_button_click_7_listener() {\n              return ctx.cargarTab(\"dueno_activas\");\n            });\n            i0.ɵɵtext(8, \" Due\\u00F1o \\u2013 Activas \");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(9, \"button\", 6);\n            i0.ɵɵlistener(\"click\", function InboxComponent_Template_button_click_9_listener() {\n              return ctx.cargarTab(\"arrendatario_activas\");\n            });\n            i0.ɵɵtext(10, \" Arrendatario \\u2013 Activas \");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(11, \"button\", 6);\n            i0.ɵɵlistener(\"click\", function InboxComponent_Template_button_click_11_listener() {\n              return ctx.cargarTab(\"historial\");\n            });\n            i0.ɵɵtext(12, \" Historial \");\n            i0.ɵɵelementEnd()();\n            i0.ɵɵtemplate(13, InboxComponent_div_13_Template, 5, 4, \"div\", 7)(14, InboxComponent_div_14_Template, 2, 0, \"div\", 8)(15, InboxComponent_div_15_Template, 2, 1, \"div\", 9)(16, InboxComponent_div_16_Template, 2, 0, \"div\", 8)(17, InboxComponent_div_17_Template, 2, 1, \"div\", 10);\n            i0.ɵɵelementEnd()();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(7);\n            i0.ɵɵclassProp(\"active\", ctx.selectedTab === \"dueno_activas\");\n            i0.ɵɵadvance(2);\n            i0.ɵɵclassProp(\"active\", ctx.selectedTab === \"arrendatario_activas\");\n            i0.ɵɵadvance(2);\n            i0.ɵɵclassProp(\"active\", ctx.selectedTab === \"historial\");\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"ngIf\", ctx.selectedTab === \"historial\");\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.loading);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", !ctx.loading && ctx.errorMessage);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", !ctx.loading && !ctx.errorMessage && ctx.items.length === 0);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", !ctx.loading && !ctx.errorMessage && ctx.items.length > 0);\n          }\n        },\n        dependencies: [i3.NgForOf, i3.NgIf, i3.DatePipe],\n        styles: [\".tabs[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}.historial-rol[_ngcontent-%COMP%]{display:flex;gap:8px;margin-bottom:12px}.grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr;gap:10px}@media (min-width: 900px){.grid[_ngcontent-%COMP%]{grid-template-columns:1fr 1fr}}.item[_ngcontent-%COMP%]{display:grid;grid-template-columns:76px 1fr;gap:12px;padding:12px;border:1px solid var(--border);border-radius:var(--radius-md);background:var(--surface-2)}.media[_ngcontent-%COMP%]{display:flex}.img[_ngcontent-%COMP%]{width:76px;height:76px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}.placeholder[_ngcontent-%COMP%]{background:var(--surface-3)}.title-row[_ngcontent-%COMP%]{display:flex;gap:8px;align-items:center;justify-content:space-between}.titulo[_ngcontent-%COMP%]{font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.sub[_ngcontent-%COMP%]{opacity:.85;font-size:14px}.actions[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;margin-top:10px}.unread[_ngcontent-%COMP%]{display:flex;align-items:center;gap:6px}.unread-badge[_ngcontent-%COMP%]{display:inline-flex;min-width:22px;height:22px;padding:0 6px;align-items:center;justify-content:center;border-radius:999px;border:1px solid rgba(20,184,166,.3);background:#14b8a62e;font-size:12px;font-weight:800;color:#05201f}.unread-text[_ngcontent-%COMP%]{font-size:12px;opacity:.85}\"]\n      });\n    }\n  }\n  return InboxComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}