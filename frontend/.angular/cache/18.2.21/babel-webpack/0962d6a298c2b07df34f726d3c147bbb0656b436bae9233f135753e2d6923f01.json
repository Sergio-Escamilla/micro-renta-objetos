{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { Validators } from '@angular/forms';\nlet RentarArticuloComponent = class RentarArticuloComponent {\n  constructor(route, router, fb, articuloService, authService, rentaService) {\n    this.route = route;\n    this.router = router;\n    this.fb = fb;\n    this.articuloService = articuloService;\n    this.authService = authService;\n    this.rentaService = rentaService;\n    this.loading = false;\n    this.errorMessage = '';\n    this.articulo = null;\n    this.esMio = false;\n    this.modalidad = 'dias';\n    this.form = this.fb.group({\n      fecha_inicio: ['', [Validators.required]],\n      fecha_fin: ['', [Validators.required]]\n    });\n  }\n  ngOnInit() {\n    const id = Number(this.route.snapshot.paramMap.get('id'));\n    if (!Number.isFinite(id) || id <= 0) {\n      this.errorMessage = 'ID de artículo inválido.';\n      return;\n    }\n    this.cargarArticulo(id);\n  }\n  volverDetalle() {\n    if (!this.articulo) {\n      this.router.navigate(['/explorar']);\n      return;\n    }\n    this.router.navigate(['/articulos', this.articulo.id]);\n  }\n  confirmarRenta() {\n    this.errorMessage = '';\n    if (!this.articulo) return;\n    if (this.esMio) {\n      this.errorMessage = 'No puedes rentar tu propio artículo.';\n      return;\n    }\n    if (this.form.invalid) {\n      this.form.markAllAsTouched();\n      this.errorMessage = 'Completa las fechas.';\n      return;\n    }\n    const inicioRaw = this.form.value.fecha_inicio ?? '';\n    const finRaw = this.form.value.fecha_fin ?? '';\n    const inicio = new Date(inicioRaw);\n    const fin = new Date(finRaw);\n    if (!(inicio instanceof Date) || isNaN(inicio.getTime()) || isNaN(fin.getTime())) {\n      this.errorMessage = 'Fechas inválidas.';\n      return;\n    }\n    if (this.modalidad === 'horas') {\n      if (inicio.getMinutes() !== 0 || fin.getMinutes() !== 0) {\n        this.errorMessage = 'Solo se permiten horas exactas (sin minutos).';\n        return;\n      }\n      const diffMs = fin.getTime() - inicio.getTime();\n      if (diffMs < 60 * 60 * 1000) {\n        this.errorMessage = 'La renta por horas debe ser de al menos 1 hora.';\n        return;\n      }\n      if (diffMs % (60 * 60 * 1000) !== 0) {\n        this.errorMessage = 'Solo se permiten horas exactas (sin minutos).';\n        return;\n      }\n    }\n    if (fin <= inicio) {\n      this.errorMessage = 'La fecha fin debe ser posterior a la fecha inicio.';\n      return;\n    }\n    this.loading = true;\n    this.rentaService.crearRenta({\n      id_articulo: this.articulo.id,\n      fecha_inicio: inicio.toISOString(),\n      fecha_fin: fin.toISOString(),\n      modalidad: this.modalidad\n    }).subscribe({\n      next: r => {\n        this.loading = false;\n        const idRenta = r.id_renta ?? r.id;\n        this.router.navigate(['/rentas/resumen', idRenta]);\n      },\n      error: err => {\n        this.loading = false;\n        const status = err?.status;\n        const hasToken = !!this.authService.getToken();\n        if ((status === 401 || status === 422) && !hasToken) {\n          this.router.navigate(['/login']);\n          return;\n        }\n        this.errorMessage = err?.error?.message || 'No se pudo crear la renta.';\n      }\n    });\n  }\n  cargarArticulo(id) {\n    this.loading = true;\n    this.articuloService.getArticuloPorId(id).subscribe({\n      next: art => {\n        this.articulo = art;\n        const userId = this.authService.getUserId();\n        this.esMio = !!userId && Number(art?.id_propietario) === userId;\n        const unidad = art?.unidad_precio;\n        this.modalidad = unidad === 'por_hora' ? 'horas' : 'dias';\n        this.loading = false;\n      },\n      error: err => {\n        this.loading = false;\n        const status = err?.status;\n        const hasToken = !!this.authService.getToken();\n        if ((status === 401 || status === 422) && !hasToken) {\n          this.router.navigate(['/login']);\n          return;\n        }\n        this.errorMessage = err?.error?.message || 'No se pudo cargar el artículo.';\n      }\n    });\n  }\n  onModalidadChange(value) {\n    this.modalidad = value === 'horas' ? 'horas' : 'dias';\n    if (this.modalidad !== 'horas') return;\n    // UX: si ya hay valores, intentar llevarlos a hora exacta (minutos=00)\n    const inicioRaw = this.form.value.fecha_inicio ?? '';\n    const finRaw = this.form.value.fecha_fin ?? '';\n    const inicio = inicioRaw ? new Date(inicioRaw) : null;\n    const fin = finRaw ? new Date(finRaw) : null;\n    const roundToHour = d => {\n      const copy = new Date(d);\n      copy.setMinutes(0, 0, 0);\n      return copy;\n    };\n    const toLocalInputValue = d => {\n      const pad = n => String(n).padStart(2, '0');\n      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;\n    };\n    const patch = {};\n    if (inicio && !isNaN(inicio.getTime())) {\n      patch.fecha_inicio = toLocalInputValue(roundToHour(inicio));\n    }\n    if (fin && !isNaN(fin.getTime())) {\n      patch.fecha_fin = toLocalInputValue(roundToHour(fin));\n    }\n    if (Object.keys(patch).length > 0) {\n      this.form.patchValue(patch);\n    }\n  }\n};\nRentarArticuloComponent = __decorate([Component({\n  selector: 'app-rentar-articulo',\n  templateUrl: './rentar-articulo.component.html',\n  styleUrls: ['./rentar-articulo.component.scss']\n})], RentarArticuloComponent);\nexport { RentarArticuloComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}